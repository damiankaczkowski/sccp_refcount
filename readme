SCCP-chan_dbugging

1 - Build sccp-chan with config flag --enable-refcount-debug. This will create a file /tmp/sccp_refs
2 - activate asterisk 'full' log in /etc/asterisk/logger.conf
3 - active the logger rotation + compression
4 - set core debug =1, core verbose 5
5 - sccp set debug 'core, device, line, channel, pbx, filelinefunc'
6 - write a cronjob to do:
  asterisk -rx "sccp show refcount"
  asterisk -rx "core show channels"
  asterisk -rx "sccp show channels"


The proicessing that needs to be done, is pretty simple:
Bash Pseudo code :
Get 'sccp show refcount' into refcount.out
Get 'sccp show channels' into channels.out
cat channel.out | awk the DEVICEMAC column from that list
grep DEVICEMAC refcount.out |grep linedevice | awk the SCCPDEVICE/SCCPLINE column | awk only the SCPLINE part

grep sccpline refcount.out | grep -v SCCPLINE > refcount.lines
grep linedevice refcount.out | grep -v DEVICEMAC/SCCPLINE > refcount.linedevices
grep sccpdevice refcount.out | grep -v DEVICEMAC > refcount.devices
diff refcount.lines refcount.lines.prev
diff refcount.linedevices refcount.linedevices.prev
diff refcount.devices refcount.devices.prev




Simple explanation. We don't want to check the refcount of devices (and related lines / channels) that currently are in a call
￼So we need to remove those results from the refcount.out file. Diff will give some problems, because we are removing different lines in both instances, so we need to do that a little differently. For example storing the results in a database table and run a diff query against that
￼(might be easiest)
￼Or tally using a python array/dictionary
￼There are a lot of ways to do this
￼I am off to the Fysiotherapist... Later !
￼Good luck and have fun programming
